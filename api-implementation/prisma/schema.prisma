generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  name           String
  password       String
  tier           String         @default("FREE")
  emailVerified  Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  planSelectedAt DateTime?
  usageCount     Int            @default(0)
  usageResetDate DateTime?
  soilAnalyses   SoilAnalysis[]
  subscription   Subscription?
  usageRecords   UsageRecord[]

  // Enhanced features
  comparativeAnalyses ComparativeAnalysis[]

  // DSS features
  dssCalculations     DSSCalculation[]

  @@map("users")
}

model Subscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  tier                 String
  status               String   @default("ACTIVE")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model UsageRecord {
  id          String   @id @default(cuid())
  userId      String?
  endpoint    String
  ipAddress   String?
  userAgent   String?
  requestData String?
  timestamp   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])

  @@map("usage_records")
}

model SoilAnalysis {
  id                    String   @id @default(cuid())
  userId                String?
  sand                  Float
  clay                  Float
  silt                  Float
  organicMatter         Float    @default(2.5)
  densityFactor         Float    @default(1.0)
  fieldCapacity         Float
  wiltingPoint          Float
  plantAvailableWater   Float
  saturation            Float
  saturatedConductivity Float
  textureClass          String
  calculationSource     String
  ipAddress             String?
  createdAt             DateTime @default(now())
  user                  User?    @relation(fields: [userId], references: [id])

  // Enhanced features relationship
  enhancedAnalysis     EnhancedSoilAnalysis?

  // DSS features relationship
  dssCalculations      DSSCalculation[]

  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("soil_analyses")
}

// NEW ENHANCED MODELS FOR ADVANCED FEATURES

// Regional soil characteristics database
model SoilRegion {
  id          String @id @default(cuid())
  
  // Geographic information
  regionName  String @unique // "US Midwest", "Mediterranean Basin", etc.
  country     String
  state       String?
  climateZone String // "Humid Continental", "Mediterranean", etc.
  
  // Regional environmental factors
  avgAnnualRainfall    Float  // mm
  avgAnnualTemperature Float  // °C
  frostFreeDays        Int?   // days per year
  
  // Typical soil characteristics for region
  typicalSandRange     String // "15-25%"
  typicalClayRange     String // "20-35%"
  typicalOMRange       String // "2-4%"
  
  // Regional adjustment factors (JSON stored as text)
  seasonalFactors      String? // JSON: seasonal adjustments
  climateAdjustments   String? // JSON: climate-based corrections
  
  // Administrative
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relationships
  enhancedAnalyses EnhancedSoilAnalysis[]
  
  @@map("soil_regions")
  @@index([country, state])
  @@index([climateZone])
}

// Enhanced soil analysis with regional data and visualization support
model EnhancedSoilAnalysis {
  id            String @id @default(cuid())
  
  // Link to base analysis
  baseAnalysisId String @unique
  baseAnalysis   SoilAnalysis @relation(fields: [baseAnalysisId], references: [id], onDelete: Cascade)
  
  // Regional context
  regionId      String?
  region        SoilRegion? @relation(fields: [regionId], references: [id], onDelete: SetNull)
  
  // Geographic location
  latitude      Float?
  longitude     Float?
  elevation     Float?  // meters above sea level
  siteDescription String? // "Field A, North Section"
  
  // Advanced soil parameters
  bulkDensity           Float?  // g/cm³
  particleDensity       Float?  // g/cm³
  totalPorosity         Float?  // %
  macroporosity         Float?  // %
  microporosity         Float?  // %
  
  // Chemical properties
  pH                    Float?
  electricalConductivity Float? // dS/m
  cationExchangeCapacity Float? // cmol/kg
  baseSaturation        Float?  // %
  
  // Physical properties  
  gravelContent         Float?  // %
  aggregateStability    Float?  // %
  infiltrationRate      Float?  // mm/hr
  
  // Calculated advanced results (stored as JSON text for flexibility)
  moistureTensionCurve  String? // JSON: tension-moisture data points
  profileData3D         String? // JSON: 3D soil profile visualization data
  seasonalVariation     String? // JSON: seasonal adjustment factors
  soilHorizons          String? // JSON: horizon data for 3D profile
  waterMovementModel    String? // JSON: water movement characteristics
  
  // Visualization metadata
  hasVisualizationData  Boolean @default(false)
  lastVisualizationCalc DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relationships
  moistureTensionPoints MoistureTensionPoint[]
  comparativeAnalyses   ComparativeAnalysis[]
  managementRecommendations SoilManagementRecommendation[]
  
  @@map("enhanced_soil_analyses")
  @@index([regionId])
  @@index([latitude, longitude])
}

// Individual moisture-tension curve data points
model MoistureTensionPoint {
  id                    String @id @default(cuid())
  
  enhancedAnalysisId    String
  enhancedAnalysis      EnhancedSoilAnalysis @relation(fields: [enhancedAnalysisId], references: [id], onDelete: Cascade)
  
  // Data point
  tension               Float  // kPa (tension/suction)
  moistureContent       Float  // % by volume
  
  // Metadata
  isCalculated          Boolean @default(true) // vs measured
  calculationMethod     String? // "Saxton-Rawls", "Van Genuchten", etc.
  
  @@map("moisture_tension_points")
  @@index([enhancedAnalysisId, tension])
}

// Comparative analysis support
model ComparativeAnalysis {
  id          String @id @default(cuid())
  
  // Analysis metadata
  name        String // "Field Comparison 2025"
  description String?
  analysisType String // "temporal", "spatial", "treatment"
  
  // User who created the comparison
  userId      String?
  user        User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Analyses being compared (stored as JSON for flexibility)
  analysisIds String  // JSON array of analysis IDs
  
  // Comparison results
  comparisonResults String? // JSON: statistical comparison results
  visualizationData String? // JSON: data for comparative charts
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Many-to-many relationship with enhanced analyses
  enhancedAnalyses EnhancedSoilAnalysis[]
  
  @@map("comparative_analyses")
  @@index([userId, createdAt])
}

// Soil management recommendations based on enhanced analysis
model SoilManagementRecommendation {
  id                    String @id @default(cuid())
  
  enhancedAnalysisId    String
  enhancedAnalysis      EnhancedSoilAnalysis @relation(fields: [enhancedAnalysisId], references: [id], onDelete: Cascade)
  
  // Recommendation details
  category              String // "irrigation", "fertilization", "tillage", "drainage"
  priority              String // "high", "medium", "low"
  title                 String
  description           String
  
  // Implementation details
  seasonalTiming        String? // "spring", "fall", etc.
  expectedImprovement   String? // "20% increase in PAW"
  costEstimate          String? // "low", "medium", "high"
  
  // Supporting data
  scientificBasis       String? // Reference to research
  localRelevance        Float?  // 0-1 relevance score for region
  
  isActive              Boolean @default(true)
  createdAt             DateTime @default(now())
  
  @@map("soil_management_recommendations")
  @@index([enhancedAnalysisId, priority])
  @@index([category])
}

// ========================================
// DSS (DECISION SUPPORT SYSTEM) MODELS
// ========================================

// Crop database for irrigation calculations
model Crop {
  id                String @id @default(cuid())

  // Basic crop information
  name              String @unique // "Tomato", "Wheat", "Maize"
  scientificName    String? // "Solanum lycopersicum"
  type              String // "Cereal", "Vegetable", "Forage", "Field"
  category          String? // "C3", "C4" for photosynthesis type

  // Growth characteristics
  growthPeriodMin   Int // minimum days from sowing to harvest
  growthPeriodMax   Int // maximum days from sowing to harvest
  rootDepthMax      Float // maximum rooting depth in meters

  // Regional adaptations
  climateZones      String? // JSON array of suitable climate zones
  soilPreferences   String? // JSON object with soil preferences

  // Administrative
  isActive          Boolean @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  bbchStages        BBCHStage[]
  kcPeriods         KcPeriod[]
  dssCalculations   DSSCalculation[]

  @@map("crops")
  @@index([type])
  @@index([name])
}

// BBCH growth stages for precise phenology tracking
model BBCHStage {
  id                String @id @default(cuid())

  // Crop relationship
  cropId            String
  crop              Crop @relation(fields: [cropId], references: [id], onDelete: Cascade)

  // BBCH stage information
  stageCode         String // "00", "10", "20", etc. (BBCH codes)
  stageName         String // "Germination", "Leaf development", etc.
  description       String? // Detailed description of the stage

  // Timing information
  typicalDaysFromSowing Int? // typical days from sowing to reach this stage
  durationDays      Int? // typical duration of this stage

  // Growth period classification
  growthPeriod      String? // "initial", "development", "mid", "late"

  @@map("bbch_stages")
  @@index([cropId, stageCode])
  @@index([growthPeriod])
}

// Crop coefficients (Kc) for different periods and conditions
model KcPeriod {
  id                String @id @default(cuid())

  // Crop relationship
  cropId            String
  crop              Crop @relation(fields: [cropId], references: [id], onDelete: Cascade)

  // Period information
  periodName        String // "Kc_ini", "Kc_dev", "Kc_mid", "Kc_end"
  periodStartDays   Int // days from sowing when period starts
  periodEndDays     Int // days from sowing when period ends

  // Kc values
  kcValue           Float // base Kc value from FAO-56
  kcMin             Float? // minimum Kc for the period
  kcMax             Float? // maximum Kc for the period

  // Environmental adjustments
  climateZone       String @default("temperate") // "arid", "humid", "temperate"
  irrigationMethod  String @default("sprinkler") // "drip", "sprinkler", "surface"

  // Quality and source information
  confidenceLevel   String @default("medium") // "high", "medium", "low"
  referenceSource   String? // "FAO-56", "Local research", etc.
  localCalibration  Boolean @default(false) // has been locally calibrated

  // Regional adjustments (JSON stored as text)
  climateAdjustments String? // JSON: climate-specific adjustments
  soilAdjustments   String? // JSON: soil-specific adjustments

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("kc_periods")
  @@index([cropId, periodName])
  @@index([climateZone, irrigationMethod])
}

// DSS calculation results and recommendations
model DSSCalculation {
  id                String @id @default(cuid())

  // User and analysis relationships
  userId            String?
  user              User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  soilAnalysisId    String
  soilAnalysis      SoilAnalysis @relation(fields: [soilAnalysisId], references: [id], onDelete: Cascade)
  cropId            String
  crop              Crop @relation(fields: [cropId], references: [id], onDelete: Cascade)

  // Field configuration
  fieldArea         Float // hectares
  fieldSlope        Float? // percentage
  fieldElevation    Float? // meters above sea level

  // Environmental inputs
  et0Value          Float? // reference evapotranspiration (mm/day)
  weatherSource     String? // "manual", "api", "flahacalc"
  climateZone       String? // for Kc adjustments

  // Calculated irrigation parameters
  etcCalculated     Float? // crop evapotranspiration (mm/day)
  irrigationDepth   Float? // recommended irrigation depth (mm)
  irrigationFrequency Int? // recommended frequency (days)
  maxApplicationRate Float? // maximum application rate (mm/hr)

  // System recommendations
  systemRecommendation String? // "drip", "sprinkler", "surface"
  systemEfficiency  Float? // estimated system efficiency (0-1)
  systemCost        Float? // estimated system cost

  // Economic analysis
  economicROI       Float? // return on investment (percentage)
  paybackPeriod     Float? // payback period (years)
  annualWaterSavings Float? // estimated annual water savings (m³)
  annualCostSavings Float? // estimated annual cost savings

  // Calculation metadata
  calculationMethod String @default("fao56") // "fao56", "enhanced", "ml"
  calculationVersion String @default("1.0") // version of calculation algorithm

  // Results storage (JSON for flexibility)
  detailedResults   String? // JSON: detailed calculation breakdown
  recommendations   String? // JSON: detailed recommendations
  scheduleData      String? // JSON: irrigation schedule

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("dss_calculations")
  @@index([userId, createdAt])
  @@index([soilAnalysisId])
  @@index([cropId])
}

// Add DSS relationship to existing SoilAnalysis model
// (This will be added as a relationship field)
